package director

import (
	"fmt"
	"io/ioutil"
	"os"
	"regexp"
	"strings"
	"testing"

	"github.com/stretchr/testify/require"
)

func saveQueryInExamples(t *testing.T, query string, exampleName string) {
	t.Helper()
	sanitizedName := strings.Replace(exampleName, " ", "-", -1)
	sanitizedName = strings.ToLower(sanitizedName)
	// replace uuids with constant value
	r, err := regexp.Compile("[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}")
	require.NoError(t, err)
	query = r.ReplaceAllString(query, "aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa")
	content := fmt.Sprintf("# Code generated by Compass integration tests, DO NOT EDIT.\n%s", query)

	dir := fmt.Sprintf("%s/src/github.com/kyma-incubator/compass/examples", os.Getenv("GOPATH"))
	err = os.MkdirAll(dir, os.ModePerm)
	require.NoError(t, err)

	err = ioutil.WriteFile(fmt.Sprintf("%s/%s.graphql", dir, sanitizedName), []byte(content), 0660)
	require.NoError(t, err)
}
