apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ include "kyma-env-broker.fullname" . }}-e2e-provisioning
  namespace: {{ .Release.Namespace }}

---

apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: {{ include "kyma-env-broker.fullname" . }}-e2e-provisioning
  namespace: {{ .Release.Namespace }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: {{ include "kyma-env-broker.fullname" . }}-e2e-provisioning
subjects:
  - kind: ServiceAccount
    name: {{ include "kyma-env-broker.fullname" . }}-e2e-provisioning
    namespace: {{ .Release.Namespace }}

---

apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: {{ include "kyma-env-broker.fullname" . }}-e2e-provisioning
  namespace: {{ .Release.Namespace }}
rules:
  - apiGroups: ["*"]
    resources: ["secrets"]
    verbs: ["get"]

---

apiVersion: "testing.kyma-project.io/v1alpha1"
kind: TestDefinition
metadata:
  name: {{ .Chart.Name }}-e2e-provisioning
  labels:
  {{ include "kyma-env-broker.labels" . | indent 4 }}
spec:
  disableConcurrency: false
  template:
    spec:
      serviceAccountName: {{ include "kyma-env-broker.fullname" . }}-e2e-provisioning
      containers:
        - name: tests
          image: {{ .Values.global.images.containerRegistry.path }}/{{ .Values.global.images.tests.e2e_provisioning.dir }}e2e-provisioning-test:{{ .Values.global.images.tests.e2e_provisioning.version }}
          imagePullPolicy: IfNotPresent
          env:
          - name: APP_BROKER_URL
            value: 'https://{{ .Values.host }}.{{ .Values.global.ingress.domainName }}'
          - name: APP_BROKER_PROVISION_TIMEOUT
            value: "3h"
          - name: APP_BROKER_PROVISION_GCP
            value: "false"
          - name: APP_BROKER_AUTH_USERNAME
            value: "{{ .Values.broker.username }}"
          - name: APP_BROKER_AUTH_PASSWORD
            valueFrom:
              secretKeyRef:
                name: {{ include "kyma-env-broker.fullname" . }}
                key: broker-password
          - name: APP_RUNTIME_PROVISIONER_URL
            value: "{{ .Values.provisioner.URL }}"
          - name: APP_RUNTIME_UUA_INSTANCE_NAME
            value: "uaa-issuer"
          - name: APP_RUNTIME_UUA_INSTANCE_NAMESPACE
            value: "kyma-system"
          - name: APP_TENANT_ID
            value: "3e64ebae-38b5-46a0-b1ed-9ccee153a0ae"
          command: ["/bin/sh"]
          args: ["-c", "echo 'Starting e2e-provisioning test. Waiting 20s for api server...'; sleep 20; ./test.test; exit_code=$?; curl -XPOST http://127.0.0.1:15020/quitquitquit; sleep 4; exit $exit_code;"]