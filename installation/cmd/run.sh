#!/usr/bin/env bash

set -o errexit

ROOT_PATH=$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )/../..

defaultRelease="latest"
KYMA_RELEASE=${1:-$defaultRelease}
COMPASS_HELM_RELEASE_NAME="compass"
COMPASS_HELM_RELEASE_NAMESPACE="compass-system"

INSTALLER_CR_PATH="${ROOT_PATH}"/installation/resources/installer-cr-kyma-diet.yaml
OVERRIDES_COMPASS_GATEWAY="${ROOT_PATH}"/installation/resources/installer-overrides-compass-gateway.yaml

GARDENER_PROJECT="test-ag"

#Arek kubeconfig
GARDENER_KUBECONFIG="YXBpVmVyc2lvbjogdjEKa2luZDogQ29uZmlnCmNsdXN0ZXJzOgogIC0gbmFtZTogZ2FyZGVuCiAgICBjbHVzdGVyOgogICAgICBjZXJ0aWZpY2F0ZS1hdXRob3JpdHktZGF0YTogPi0KICAgICAgICBMUzB0TFMxQ1JVZEpUaUJEUlZKVVNVWkpRMEZVUlMwdExTMHRDazFKU1VSVGFrTkRRV3BMWjBGM1NVSkJaMGxWV2pSVFVXUm1VRVZVZG1SblJtVlFUVmgwZEU0MVJuSlZhREZKZDBSUldVcExiMXBKYUhaalRrRlJSVXdLUWxGQmQwdDZSWEJOUTJOSFFURlZSVUY0VFdka2JXeDVaRWhXYUdKRE1XNVpXRXByV2xjME5sa3lSVFpoTTFacFdsTXhhR05IYkhwYVdFb3lXbGhKZHdwSWFHTk9UVlJuZUUxcVJUVk5WRWw1VFZSQmQxZG9ZMDVOYWsxNFRXcEZORTFVU1hsTlZFRjNWMnBCY2sxVGEzZEtkMWxFVmxGUlJFVjVRakpoV0Vvd0NtUlhSbk5NVjJSb1kyMVNiR0pxY0dwWlZIQnlaRmRLYkV4WFJuZGhXRTVzWTI1YWJHTnFRME5CVTBsM1JGRlpTa3R2V2tsb2RtTk9RVkZGUWtKUlFVUUtaMmRGVUVGRVEwTkJVVzlEWjJkRlFrRk9XRWt2WjBFM1lXVnBWa3hMVkdWQ1ZFcHhZazVoTTNKck9IcGFWVWNyTlhsbkx5OVdVMVJsTWxWdGIyMXJad29yTWxOeFkyOTFaaXM0UzA1Rk0wWlNMMWh5WlRSNWNXTTFTMmRYV0VkS1VXZHhNV2wxYTNSV2RuVkJSekZTUmpaamFtRk1RbEUwTVdOWk5IRjZUR0o2Q2k5VGRGaElSVlZNUjNOaFJFTkdhR1JLWjB3ek5YSmpiSGgwWmk5T2NHUnZjemN6VXpodlFuVjJkakZQVmsxTlNEWTNZMHRvUmt4T2FqRlNaV2R4Y0hNS04yWmhjWEF5WlhKc05WQjFVbFppU2pZNWQyOXhLMEUzWVM5R1VrdEtOM0pCYlVOclV6aGFlSFJhVkhaM1kyWlZVRE5QYnpsNGJFZGxRa2gxVlVsdlVnb3dNVzlIWWxjMldHcGpORE5UYnl0bGNGUmtVWEJ4WlROV05qaHFlR2d5YmtWNE5YRmhlRFo0WWpKSlRDOVZVWGxwUWxScGJFaEZUa04yVGsxV1oySnFDbkU0VFVOQ1NqZHVVR2hvWkdrdlJUSnJaalJZWTJGR1JYWnljSE4wWXpOUWVURlhWMU5WUlVOQmQwVkJRV0ZPYlUxSFVYZEVaMWxFVmxJd1VFRlJTQzhLUWtGUlJFRm5SVWROUWtsSFFURlZaRVYzUlVJdmQxRkpUVUZaUWtGbU9FTkJVVWwzU0ZGWlJGWlNNRTlDUWxsRlJreHVia05KV1Zsd2RIZGhRMDVTYndwWGJHZ3JPV2d3ZDJKMFdsaE5RamhIUVRGVlpFbDNVVmxOUW1GQlJreHVia05KV1Zsd2RIZGhRMDVTYjFkc2FDczVhREIzWW5SYVdFMUJNRWREVTNGSENsTkpZak5FVVVWQ1EzZFZRVUUwU1VKQlVVSlpPRGhTV1dGWmIwTkJWWGx4U21rNFZERnllRTVFTkVKUWVVWXhaVGxGZW1WQk1HaFhkVVZqYnpkRlFtY0themREVTJObGFtRnlOVlJVTkRNMkwxa3ZWMU1yYTBaM2JVRjFMM0kzT1d0SU1UQjNNVkEzVW5JMmRFRkNaMUJKY2k5MU1FeFZha281TlhjMWVHNWlkUXBoVFc5RGRWQjRTWFkyU1VkQ056Vmhaa2hVVmt4UmJrTkdSREJaUzBObVJYVnVhMkpaUzA5dmVXSldSR0p3WVV3eU5EaFdTbmw2Y1VSYWMwWlJVMlY1Q2xKMVFraG9lVGR0UnpSSFNsb3pha3R3ZEV4VlUzSk9NbW93ZW1WMlUyRTJWbW8xTDJWaWMyZzBVRGd2VlhCdGVFcHVNWFJvUkdaSk5VY3JkRVowY1RFS2JtZFZUa1JzVGpKV2VqTkpkVGhCTHpkU1ZsUnhiMWhHVHpSRWNHSmFVSEZuUjJGeVpVVkpXbU5QTjFKellqQktjMHhGWnpGd1dHcHZWbW8wYmtOWVNncGhNbWRhZFdkQlZuRjNZa051UzJaT01WQlJPRnAwYkZSS2JERm5VU3QyYlVsalRsUnRha0ZXQ2kwdExTMHRSVTVFSUVORlVsUkpSa2xEUVZSRkxTMHRMUzA9CiAgICAgIHNlcnZlcjogJ2h0dHBzOi8vZ2FyZGVuZXIuZ2FyZGVuLmNhbmFyeS5rOHMub25kZW1hbmQuY29tJwp1c2VyczoKICAtIG5hbWU6IGFnYWx3YXMKICAgIHVzZXI6CiAgICAgIHRva2VuOiA+LQogICAgICAgIGV5SmhiR2NpT2lKU1V6STFOaUlzSW10cFpDSTZJaUo5LmV5SnBjM01pT2lKcmRXSmxjbTVsZEdWekwzTmxjblpwWTJWaFkyTnZkVzUwSWl3aWEzVmlaWEp1WlhSbGN5NXBieTl6WlhKMmFXTmxZV05qYjNWdWRDOXVZVzFsYzNCaFkyVWlPaUpuWVhKa1pXNHRkR1Z6ZEMxaFp5SXNJbXQxWW1WeWJtVjBaWE11YVc4dmMyVnlkbWxqWldGalkyOTFiblF2YzJWamNtVjBMbTVoYldVaU9pSmhaMkZzZDJGekxYUnZhMlZ1TFdOdWJUUnpJaXdpYTNWaVpYSnVaWFJsY3k1cGJ5OXpaWEoyYVdObFlXTmpiM1Z1ZEM5elpYSjJhV05sTFdGalkyOTFiblF1Ym1GdFpTSTZJbUZuWVd4M1lYTWlMQ0pyZFdKbGNtNWxkR1Z6TG1sdkwzTmxjblpwWTJWaFkyTnZkVzUwTDNObGNuWnBZMlV0WVdOamIzVnVkQzUxYVdRaU9pSmtZV0k1TTJRNU5TMWtaR014TFRReE56QXRPR1JqT0MwM05qRTBOVEJpT1RnM1l6QWlMQ0p6ZFdJaU9pSnplWE4wWlcwNmMyVnlkbWxqWldGalkyOTFiblE2WjJGeVpHVnVMWFJsYzNRdFlXYzZZV2RoYkhkaGN5SjkuQ2ZsMUk4bGVtODE4MGpmenZvSkcySDVRVVltVXFhU2tpX1hJMmlPQWgzMzFuRzgtUmN4eXBYeklzU0FhMmFHUXBzbk5yWmh1bGFkcXMxUTg0NWRQb1l6X3p1RFlNN01sS0ozeEdDYnFEOUd3bVYzbWt4S3pSSEp2R1VwLXhnNW1uWFNPUWpmV3N4ZHdWOUtSNmRxTkdTY09HMUhXZjloN3kyNXVmODNnd0RQV2VWLXBXdVJLdHJFZmpUUU92OUdIUl9QZHBlSFdSNi1Rc1JhOGU1OVRkUUgzNkdnWkc0VlNwZW43MW9TZzRKY0pFSE9UZ3lwZjZSMUxWUld6cHJiMXNBSXl3TUhOb2RVTHkwUG5YRExYeUJfdE1IdmV3ckpJaDdRbGk0YThKMmQyZmJZV29KNWVjRkV2d3hOeFZSTGl0S3hKZkNWUlR6QU0tRG9qX0pybDZ3CmNvbnRleHRzOgogIC0gbmFtZTogJ2dhcmRlbi10ZXN0LWFnLXN5c3RlbTpzZXJ2aWNlYWNjb3VudDpnYXJkZW4tdGVzdC1hZzphZ2Fsd2FzJwogICAgY29udGV4dDoKICAgICAgY2x1c3RlcjogZ2FyZGVuCiAgICAgIHVzZXI6IGFnYWx3YXMKICAgICAgbmFtZXNwYWNlOiBnYXJkZW4tdGVzdC1hZwpjdXJyZW50LWNvbnRleHQ6ICdnYXJkZW4tdGVzdC1hZy1zeXN0ZW06c2VydmljZWFjY291bnQ6Z2FyZGVuLXRlc3QtYWc6YWdhbHdhcycK"


#GARDENER_PROJECT="test-pg"
#Przemek kubeconfig
# "a2luZDogQ29uZmlnCmNsdXN0ZXJzOgogIC0gY2x1c3RlcjoKICAgICAgY2VydGlmaWNhdGUtYXV0aG9yaXR5LWRhdGE6ID4tCiAgICAgICAgTFMwdExTMUNSVWRKVGlCRFJWSlVTVVpKUTBGVVJTMHRMUzB0Q2sxSlNVUlRha05EUVdwTFowRjNTVUpCWjBsVldqUlRVV1JtVUVWVWRtUm5SbVZRVFZoMGRFNDFSbkpWYURGSmQwUlJXVXBMYjFwSmFIWmpUa0ZSUlV3S1FsRkJkMHQ2UlhCTlEyTkhRVEZWUlVGNFRXZGtiV3g1WkVoV2FHSkRNVzVaV0VwcldsYzBObGt5UlRaaE0xWnBXbE14YUdOSGJIcGFXRW95V2xoSmR3cElhR05PVFZSbmVFMXFSVFZOVkVsNVRWUkJkMWRvWTA1TmFrMTRUV3BGTkUxVVNYbE5WRUYzVjJwQmNrMVRhM2RLZDFsRVZsRlJSRVY1UWpKaFdFb3dDbVJYUm5OTVYyUm9ZMjFTYkdKcWNHcFpWSEJ5WkZkS2JFeFhSbmRoV0U1c1kyNWFiR05xUTBOQlUwbDNSRkZaU2t0dldrbG9kbU5PUVZGRlFrSlJRVVFLWjJkRlVFRkVRME5CVVc5RFoyZEZRa0ZPV0VrdlowRTNZV1ZwVmt4TFZHVkNWRXB4WWs1aE0zSnJPSHBhVlVjck5YbG5MeTlXVTFSbE1sVnRiMjFyWndvck1sTnhZMjkxWmlzNFMwNUZNMFpTTDFoeVpUUjVjV00xUzJkWFdFZEtVV2R4TVdsMWEzUldkblZCUnpGU1JqWmphbUZNUWxFME1XTlpOSEY2VEdKNkNpOVRkRmhJUlZWTVIzTmhSRU5HYUdSS1owd3pOWEpqYkhoMFppOU9jR1J2Y3pjelV6aHZRblYyZGpGUFZrMU5TRFkzWTB0b1JreE9hakZTWldkeGNITUtOMlpoY1hBeVpYSnNOVkIxVWxaaVNqWTVkMjl4SzBFM1lTOUdVa3RLTjNKQmJVTnJVemhhZUhSYVZIWjNZMlpWVUROUGJ6bDRiRWRsUWtoMVZVbHZVZ293TVc5SFlsYzJXR3BqTkROVGJ5dGxjRlJrVVhCeFpUTldOamhxZUdneWJrVjROWEZoZURaNFlqSkpUQzlWVVhscFFsUnBiRWhGVGtOMlRrMVdaMkpxQ25FNFRVTkNTamR1VUdob1pHa3ZSVEpyWmpSWVkyRkdSWFp5Y0hOMFl6TlFlVEZYVjFOVlJVTkJkMFZCUVdGT2JVMUhVWGRFWjFsRVZsSXdVRUZSU0M4S1FrRlJSRUZuUlVkTlFrbEhRVEZWWkVWM1JVSXZkMUZKVFVGWlFrRm1PRU5CVVVsM1NGRlpSRlpTTUU5Q1FsbEZSa3h1YmtOSldWbHdkSGRoUTA1U2J3cFhiR2dyT1dnd2QySjBXbGhOUWpoSFFURlZaRWwzVVZsTlFtRkJSa3h1YmtOSldWbHdkSGRoUTA1U2IxZHNhQ3M1YURCM1luUmFXRTFCTUVkRFUzRkhDbE5KWWpORVVVVkNRM2RWUVVFMFNVSkJVVUpaT0RoU1dXRlpiME5CVlhseFNtazRWREZ5ZUU1RU5FSlFlVVl4WlRsRmVtVkJNR2hYZFVWamJ6ZEZRbWNLYXpkRFUyTmxhbUZ5TlZSVU5ETTJMMWt2VjFNcmEwWjNiVUYxTDNJM09XdElNVEIzTVZBM1VuSTJkRUZDWjFCSmNpOTFNRXhWYWtvNU5YYzFlRzVpZFFwaFRXOURkVkI0U1hZMlNVZENOelZoWmtoVVZreFJia05HUkRCWlMwTm1SWFZ1YTJKWlMwOXZlV0pXUkdKd1lVd3lORGhXU25sNmNVUmFjMFpSVTJWNUNsSjFRa2hvZVRkdFJ6UkhTbG96YWt0d2RFeFZVM0pPTW1vd2VtVjJVMkUyVm1vMUwyVmljMmcwVURndlZYQnRlRXB1TVhSb1JHWkpOVWNyZEVaMGNURUtibWRWVGtSc1RqSldlak5KZFRoQkx6ZFNWbFJ4YjFoR1R6UkVjR0phVUhGblIyRnlaVVZKV21OUE4xSnpZakJLYzB4Rlp6RndXR3B2Vm1vMGJrTllTZ3BoTW1kYWRXZEJWbkYzWWtOdVMyWk9NVkJST0ZwMGJGUktiREZuVVN0MmJVbGpUbFJ0YWtGV0NpMHRMUzB0UlU1RUlFTkZVbFJKUmtsRFFWUkZMUzB0TFMwPQogICAgICBzZXJ2ZXI6ICdodHRwczovL2dhcmRlbmVyLmdhcmRlbi5jYW5hcnkuazhzLm9uZGVtYW5kLmNvbScKICAgIG5hbWU6IGdhcmRlbgp1c2VyczoKICAtIHVzZXI6CiAgICAgIHRva2VuOiA+LQogICAgICAgIGV5SmhiR2NpT2lKU1V6STFOaUlzSW10cFpDSTZJaUo5LmV5SnBjM01pT2lKcmRXSmxjbTVsZEdWekwzTmxjblpwWTJWaFkyTnZkVzUwSWl3aWEzVmlaWEp1WlhSbGN5NXBieTl6WlhKMmFXTmxZV05qYjNWdWRDOXVZVzFsYzNCaFkyVWlPaUpuWVhKa1pXNHRkR1Z6ZEMxd1p5SXNJbXQxWW1WeWJtVjBaWE11YVc4dmMyVnlkbWxqWldGalkyOTFiblF2YzJWamNtVjBMbTVoYldVaU9pSndaMjlzYVdONkxXczRjeTFoWTJOdmRXNTBMWFJ2YTJWdUxYaGlZMlJ6SWl3aWEzVmlaWEp1WlhSbGN5NXBieTl6WlhKMmFXTmxZV05qYjNWdWRDOXpaWEoyYVdObExXRmpZMjkxYm5RdWJtRnRaU0k2SW5CbmIyeHBZM290YXpoekxXRmpZMjkxYm5RaUxDSnJkV0psY201bGRHVnpMbWx2TDNObGNuWnBZMlZoWTJOdmRXNTBMM05sY25acFkyVXRZV05qYjNWdWRDNTFhV1FpT2lJek0yVTBNVE0xTUMxa1pUSTJMVFF3WVRndFltRm1NeTAzWldRd1pqSTRNekpoTURnaUxDSnpkV0lpT2lKemVYTjBaVzA2YzJWeWRtbGpaV0ZqWTI5MWJuUTZaMkZ5WkdWdUxYUmxjM1F0Y0djNmNHZHZiR2xqZWkxck9ITXRZV05qYjNWdWRDSjkua2dlZlhxYWdaWktQRkNNVmdYOUk5RXBZNGtxaG5WamJqS1lia1A1WXk5RjlZTFJtOEpNX2RDZGhhNExZVWk1bkVENmFhX0ZXWjNxZVdod3JLQVRwRzd5eE03Z2tsLW1pSWpwSl9HMkFGVEpIZm1EemtlcFJpM0ZVbXVwNktCRG16SUJxWXBENTRSVjJYN2hLVDJ4Zk12T19Wcl92WDhmRnBiY0dUaHBYcnhtYUJHU2RjZ3VaNGhkYmNkTHhxRXZEQzZRYjdJT3pjZzlibENnMnhpWUNWQzdJS1BWbjQzV20tSGh4ZmxaS0xuT0o2dGU0NVJpcnVYNjBoUjBLbWNkRmRhamtxSC1LRjJ6dzFfU0hXRTFIdHlvVlVJazExYzdjb0pBUnEtdHQ0WU1kZFBQbGRXSTlDTFF0N1pvN0wtUEU4RW52ZTIwRUE4ckNvODBDcjRrRWVBCiAgICBuYW1lOiBwZ29saWN6LWs4cy1hY2NvdW50CmNvbnRleHRzOgogIC0gY29udGV4dDoKICAgICAgY2x1c3RlcjogZ2FyZGVuCiAgICAgIHVzZXI6IHBnb2xpY3otazhzLWFjY291bnQKICAgICAgbmFtZXNwYWNlOiBnYXJkZW4tdGVzdC1wZwogICAgbmFtZTogJ2dhcmRlbi10ZXN0LXBnLXN5c3RlbTpzZXJ2aWNlYWNjb3VudDpnYXJkZW4tdGVzdC1wZzpwZ29saWN6LWs4cy1hY2NvdW50JwpjdXJyZW50LWNvbnRleHQ6ICdnYXJkZW4tdGVzdC1wZy1zeXN0ZW06c2VydmljZWFjY291bnQ6Z2FyZGVuLXRlc3QtcGc6cGdvbGljei1rOHMtYWNjb3VudCcK" # Base64 encoded Gardener SA key

kyma provision minikube --vm-driver virtualbox
kyma install -o $INSTALLER_CR_PATH  -o $OVERRIDES_COMPASS_GATEWAY --source "${KYMA_RELEASE}"

#Get Tiller tls client certificates
kubectl get -n kyma-installer secret helm-secret -o jsonpath="{.data['global\.helm\.ca\.crt']}" | base64 --decode > "$(helm home)/ca.pem"
kubectl get -n kyma-installer secret helm-secret -o jsonpath="{.data['global\.helm\.tls\.crt']}" | base64 --decode > "$(helm home)/cert.pem"
kubectl get -n kyma-installer secret helm-secret -o jsonpath="{.data['global\.helm\.tls\.key']}" | base64 --decode > "$(helm home)/key.pem"
echo -e "Secrets with Tiller tls client certificates have been created \n"

MINIKUBE_IP=$(eval minikube ip)
helm install --set=global.minikubeIP=${MINIKUBE_IP} --set=director.deployment.allowJWTSigningNone=true --set=global.isLocalEnv=true --set=global.provisioning.enabled=true --set=provisioner.gardener.kubeconfig="${GARDENER_KUBECONFIG}" --set=provisioner.gardener.project="${GARDENER_PROJECT}" --name "${COMPASS_HELM_RELEASE_NAME}" --namespace "${COMPASS_HELM_RELEASE_NAMESPACE}" "${ROOT_PATH}"/chart/compass --tls --wait

# TODO: Remove it after next CLI release
echo "Adding Compass entries to /etc/hosts..."
sudo sh -c 'echo "\n$(minikube ip) adapter-gateway.kyma.local adapter-gateway-mtls.kyma.local compass-gateway-mtls.kyma.local compass-gateway-auth-oauth.kyma.local compass-gateway.kyma.local compass.kyma.local compass-mf.kyma.local kyma-env-broker.kyma.local" >> /etc/hosts'
