# Operations Controller

## Overview

Operations Controller is a [Kubebuilder](https://github.com/kubernetes-sigs/kubebuilder) project. This Kubebuilder project features an `Operation` of type CustomResourceDefinition (CRD) and a Kubernetes Controller for it. It also provides several key resources that are accessible at the given locations:

- `api/v1alpha1/operation_types.go`\
The `operation_types.go` file contains the CRD that is generated by the Operations Controller.

- `config/crd/bases/operations.compass_operations.yaml`\
The `operations.compass_operations.yaml` file is generated from the `operation_types.go` CRD.

- `config/samples/operations_v1alpha1_operation.yaml`\
The `operations_v1alpha1_operation.yaml` file contains a sample of the CRD.

- `controllers/operation_controller.go`\
The `operation_controller.go` file is a Kubernetes controller for the CRD.

## Prerequisites

- Docker
- Kubernetes CLI
- Kubernetes cluster

## Installation

### CRD

1. To install the CRD into a Kubernetes cluster, use the following command: `make manifests` to generate the CRD.
2. Then apply the generated CRD file onto the cluster with `kubectl apply -f ${CRD_FILE_NAME}.yaml`.

### Controller

0. Make sure you have the CRD installed.
1. To deploy the Kubernetes controller for the operation CRD onto a Kubernetes cluster, create a Docker image using `docker build -t compass/${IMAGE_NAME} .` and push it to a Docker repository using `docker push ${IMAGE_NAME}`.
2. To run the controller, create an instance of the Docker image in the Kubernetes cluster using the following command: `kubectl run operations-controller --image=${IMAGE_NAME}`. If there's an already existing Kubernetes deployment for the controller (i.e., if you have a local installation of Compass), just hotswap its image. 

## Usage and Development

### CRD

1.	If there are changes to the CRD, you must regenerate the files that define the CRD.\
To do this, use the following command: `make manifests`.

2.	As a next step, you must copy these files to the component's Helm chart at the following location: `compass/chart/compass/charts/operations-controller`.\
To do this, use the following command: `make copy-crds-to-chart`.

### Controller

If there are changes to the controller you should create a Docker image for the new version of the controller. Then, deploy the image manually on a Kubernetes cluster.
