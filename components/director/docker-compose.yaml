version: '3.1'
services:
  primary:
    image: postgres:12
    container_name: test-postgres
    environment:
      POSTGRES_HOST: "127.0.0.1"
      POSTGRES_USER: "postgres"
      POSTGRES_PASSWORD: "pgsql@12345"
      POSTGRES_DB: "compass"
      POSTGRES_PORT: "5432"
      PGDATA: /var/lib/postgresql/data
    volumes:
      - /Users/i537925/SAPDevelop/go/src/github.com/kyma-incubator/compass/components/schema-migrator/migrations/:/tmp/migrations
      - /Users/i537925/SAPDevelop/go/src/github.com/kyma-incubator/compass/components/schema-migrator/seeds:/tmp
      - /Users/i537925/SAPDevelop/go/src/github.com/kyma-incubator/compass/components/schema-migrator/repl:/tmp
    networks:
      - app-network
    ports:
      - "5432:5432"
    command: >
      postgres &
      && sleep 2000
      && psql -U "${POSTGRES_USER}" -h "${POSTGRES_HOST}" -p "${POSTGRES_PORT}" -d "${POSTGRES_DB}" -f /tmp/repl/init-primary.sql
      && for file in /tmp/migrations/director/*.up.sql; do; psql -U "${POSTGRES_USER}" -h "${POSTGRES_HOST}" -p "${POSTGRES_PORT}" -d "${POSTGRES_DB}" -f "${file}"; done;
      && for file in /tmp/director/*.sql; do; psql -U "${POSTGRES_USER}" -h "${POSTGRES_HOST}" -p "${POSTGRES_PORT}" -d "${POSTGRES_DB}" -f "${file}"; done;
  secondary:
    image: postgres:15
    container_name: test-postgres-replica
    environment:
      POSTGRES_HOST: "127.0.0.1"
      POSTGRES_USER: "postgres"
      POSTGRES_PASSWORD: "pgsql@12345"
      POSTGRES_DB: "compass"
      POSTGRES_PORT: "6432"
      POSTGRES_REPLICATION_MODE: slave
      POSTGRES_REPLICATION_USER: replicator
      POSTGRES_REPLICATION_PASSWORD: repl123
      POSTGRES_REPLICATION_HOST: test-postgres
      POSTGRES_REPLICATION_PORT: 5432
      PGDATA: /var/lib/postgresql/data
    volumes:
      - /Users/i537925/SAPDevelop/go/src/github.com/kyma-incubator/compass/components/schema-migrator/migrations/:/tmp/migrations
      - /Users/i537925/SAPDevelop/go/src/github.com/kyma-incubator/compass/components/schema-migrator/seeds:/tmp
      - /Users/i537925/SAPDevelop/go/src/github.com/kyma-incubator/compass/components/schema-migrator/repl/*:/tmp
    networks:
      - app-network
    ports:
      - "6432:6432"
    command: |
      postgres &
      && sleep 2000
      && psql -U "${POSTGRES_USER}" -h "${POSTGRES_HOST}" -p "${POSTGRES_PORT}" -d "${POSTGRES_DB}" -f /tmp/repl/init-replica.sql
      && for file in /tmp/migrations/director/*.up.sql; do; psql -U "${POSTGRES_USER}" -h "${POSTGRES_HOST}" -p "${POSTGRES_PORT}" -d "${POSTGRES_DB}" -f "${file}"; done;
      && for file in /tmp/director/*.sql; do; psql -U "${POSTGRES_USER}" -h "${POSTGRES_HOST}" -p "${POSTGRES_PORT}" -d "${POSTGRES_DB}" -f "${file}"; done;
networks:
  app-network:
    driver: bridge